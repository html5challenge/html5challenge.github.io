---
layout: post
title: 关于美团融合项目的一些经验和想法
---

从一月初以来，我接到了一系列融合相关的项目。这些项目有一些共同之处：项目前期在点评端已经开发过类似业务，虽然业务上无需大改，但是样式上需要做不少修改；另一方面项目涉及美团和点评两边的产品和开发人员沟通，特别是开店宝开发过程中jsbridge的重新引入，需要从长远考虑来看需求。为了在今后的美团融合项目中改善这些情况,现在总结出以下几点经验：

#### 1. 通过设置属性，添加美团融合样式


自从拿到美团UI样式规范之后就发现，美团样式与点评存在较大的差异，从颜色（一边是青色，一边是橙色）到按钮，分页，导航栏等样式都有所不同。动手之前想了几套更改方案：<br />
<br />
a. 专门给美团写一套css，通过后端判断环境传回的值，决定采用哪种css<br />
b. 通过js动态设置页面css<br />
c. 在css里设置属性样式，同时html通过后端判断环境填上属性值<br />

三套方案的利弊分析下来，a方案最为简单粗暴，优点是修改起来快，业务逻辑清晰，缺点是每个css要多一个副本，对于像商家中心这样的大项目，现有的文件数已近超出code负荷的情况下，并不适合；b方案，优点是无需增加一套美团侧的css样式，但是在每个页面的js里要设置对应的美团css，改动较大，调试起来复杂；c方案，优点是只针对要修改的样式做单独修改，例如通过属性另外定义美团的按钮样式，既不增加css文件，后端也只要在html上加上属性就可以了。**最后决定采用c方案。在美团ECOM和开店宝一期中采用下来觉得比较方便，提高了样式融合的开发效率**


`data-theme="mt"`

![_config.yml]({{ site.baseurl }}/images/set-mt-attr.png)

#### 2. 开店宝和点评管家jsbridge共存的开发模式


***开店宝jsbridge目前还在建设阶段，目前较稳定的版本仅支持到4.8版***

原有的点评管家jsbridge在开店宝中不起作用，例如跳转、关页面、数据存储、右上角按钮、toast等功能依赖于jsbridge的实现。<br />开店宝融合，同样面临三种选择：<br />
一种是新开项目，专门写一套开店宝的项目，这是最彻底的方法，缺点是开发周期长，涉及到前后端改动都较大，后期有新需求要维护两套代码，该方案适合于两种APP业务差别很大的情况使用，经过与产品的确认，认为今后业务有差异的可能性较小，因此没有采纳；<br />
第二种是摈弃jsbridge的方法，由前端完全实现跳转功能，该方法需要将前端项目进行重构，现有的页面全部写在一个html中，逻辑复杂，开发周期较长，也没有采纳；<br />
**最后采用的方法是通过后端传值判断APP环境是开店宝还是点评管家，在js中引用不同的jsbridge，优点是不用增加前端的文件数量**


#### 3. 开店宝js调用顺序

MTNB(meituan native bridge)，是用来在混合应用开发中打通客户端应用（美团app，开店宝，猫眼等）与网页应用信道的桥梁。MTNB架构：

![_config.yml]({{ site.baseurl }}/images/MTNB.png)

* mtnb-core由美团的npm模块提供，业务方不需要关心。
* mtnb和mtnb-merchant依赖于mtnb-core，并封装了BA认证过程，业务方不需要关心，直接调用即可。
* mtnb-merchant扩展了两部分功能，native支持的和js mock的接口。
* @dp/util-mtshop-ui-less提供了基础样式组件以及mtnb-merchant js相关UI接口的样式。

为了方便业务层使用，底层技术提供了mtnb-merchant作为js接入层，在js一开始需要引入，该接入层调用方法与点评管家jsbridge已经十分类似
`MTNB = require('mtnb-merchant')`

因为该接入层已经包括`mtnb.js`，如果同时引入mtnb会在运行时出错

另外与点评管家不同的是，开店宝需要有一个鉴权的过程，目前已经封装在ready方法中，每个新开页面都需要调用该方法才可以使用mtnb的jsbridge方法

```
MTNB.ready(function() {
    // 业务代码
    MTNB.use(...);
});
```
具体源代码可以参考[文档](http://wiki.sankuai.com/pages/viewpage.action?pageId=219950110)中的init方法

实际调用jsbridge方法时可以用`MTNB.use`<br />
例如开页面跳转功能：

```
 MTNB.use('webview.open', {
 	url: new Url(_this.planDetailUrl).parameter({
    campaignId: planId
 	}).toString()
})
```
但是该方法在安卓上尚未调通，在开店宝融合一期，采用了该方法，并且只对开店宝4.8版本有稳定支持。目前`MTNB`的方法本身也在建设和扩展中，到4.9版(3/10发布)将支持安卓上的跳转，可以采用
`webviewBasicOperation.setLoadWebViewWithParams`方法，到时jsbridge还将更好支持右上角按钮设置，localStorage存储和`setHTMLTitle`等方法。详情可参见[文档](http://wiki.sankuai.com/pages/viewpage.action?pageId=413045245)


#### 4. 降低间接沟通的成本,提高项目成员之间的沟通效率
经过一季度美团开店宝一期的开发,发现期间需要沟通的人员,除了平时经常接触的产品,后端开发,测试之外,还有一部分是美团开店宝开发人员和点评其他前端组的成员。随着大象的推出,给点评和美团之间的交流架设了一座桥梁,在大象的人员名片中我们可以看到该成员的组织架构和手机联系方式,十分方便.

   ![_config.yml]({{ site.baseurl }}/images/business-card.png)

另外与陌生人联系可以直接ping对方，无需添加对方为好友，最简单有效的方式是每个项目的相关人员直接拉到一个群里讨论。现有的固定群有**推广通接入ecom**，**开店宝技术讨论**等